---
import { Image } from 'astro:assets';
import { Icon } from 'astro-icon/components';
import { twMerge } from 'tailwind-merge';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import Badge from './ui/Badge.astro';

interface Props {
	limit?: number;
	class?: string;
}

type Project = CollectionEntry<'projects'>['data'];

const { class: classes, limit } = Astro.props;

const allProjects = await getCollection('projects');
const projects = limit ? allProjects.slice(0, limit) : allProjects;

const techIcons: Record<Project['tech'][number], string> = {
	TypeScript: 'logos:typescript-icon',
	Gatsby: 'logos:gatsby',
	React: 'logos:react',
	ChakraUI: 'chakra-ui',
	Framer: 'logos:framer',
	Netlify: 'logos:netlify-icon',
	'Decap CMS': 'decap-cms',
	Astro: 'logos:astro-icon',
	SolidJS: 'logos:solidjs-icon',
	TailwindCSS: 'logos:tailwindcss-icon',
	Remix: 'logos:remix-icon',
	SST: 'logos:sst-icon',
	'AWS CDK': 'cdk',
	AWS: 'logos:aws',
	Supabase: 'logos:supabase-icon',
	PostgreSQL: 'logos:postgresql',
	MySQL: 'logos:mysql',
	PHP: 'logos:php',
	Wordpress: 'logos:wordpress-icon',
	WooCommerce: 'logos:woocommerce-icon',
	NextJS: 'logos:nextjs-icon',
	PWA: 'logos:pwa',
	Vercel: 'logos:vercel-icon',
	Strapi: 'logos:strapi-icon',
	'Shopify Hydrogen': 'hydrogen',
	Turso: 'turso',
};

const typeToVariant = {
	website: 'purple' as const,
	'Shopify app': 'green' as const,
	SaaS: 'blue' as const,
	eCommerce: 'yellow' as const,
	PWA: 'pink' as const,
} satisfies Record<Project['type'], string>;

const statusToVariant = {
	ongoing: 'blue' as const,
	done: 'green' as const,
	paused: 'slate' as const,
	sold: 'yellow' as const,
	sunset: 'orange' as const,
} satisfies Record<Project['status'], string>;
---

<ul class={twMerge('grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3', classes)}>
	{
		projects.map((project, projectIndex) => {
			return (
				<li
					class="group relative flex flex-col gap-5 overflow-hidden rounded-2xl border border-slate-200/60 bg-white p-6 shadow-sm transition-all duration-300 focus-within:ring-2 focus-within:ring-indigo-500 focus-within:ring-offset-2 hover:border-indigo-200 hover:shadow-lg hover:shadow-indigo-100/50"
					style={{ transform: 'translateZ(0)' }}
				>
					{/* Hover gradient overlay */}
					<div class="pointer-events-none absolute inset-0 -z-10 bg-linear-to-br from-indigo-50/0 via-transparent to-blue-50/0 opacity-0 transition-opacity duration-300 group-hover:opacity-100" />

					<div class="relative grow">
						<div class="flex h-14 w-14 items-center justify-center rounded-xl bg-slate-50 p-2 ring-1 ring-slate-100 transition-all group-hover:bg-white group-hover:shadow-md">
							<Image
								src={project.data.logo}
								alt={`${project.data.title} logo`}
								height={40}
								format="avif"
								class="h-10 w-auto object-contain"
							/>
						</div>
						<h3 class="mt-4 text-lg font-semibold text-slate-900 transition-colors group-hover:text-indigo-600">
							{project.data.title}
						</h3>
						<p class="mt-2 text-sm leading-relaxed text-slate-600">{project.data.description}</p>
					</div>

					<a href={project.data.url} class="absolute inset-0 focus:outline-none">
						<span class="sr-only">Visit {project.data.title}</span>
					</a>

					<div class="mt-auto space-y-4">
						<div class="flex flex-wrap gap-2">
							<Badge variant={typeToVariant[project.data.type]}>
								<Icon name="lucide:tag" slot="icon-left" class="h-3 w-3" />
								{project.data.type}
							</Badge>

							<Badge variant={statusToVariant[project.data.status]}>
								<Icon name="lucide:activity" slot="icon-left" class="h-3 w-3" />
								{project.data.status}
							</Badge>
						</div>

						<div class="flex items-center gap-3 border-t border-slate-100 pt-4">
							{project.data.tech.map((tech, techIndex) => (
								<div class="relative z-10">
									<Icon
										name={techIcons[tech]}
										class="peer h-5 w-auto opacity-60 transition-opacity hover:opacity-100"
										aria-describedby={`tooltip-${projectIndex}-${techIndex}`}
									/>
									<span
										role="tooltip"
										id={`tooltip-${projectIndex}-${techIndex}`}
										class="absolute bottom-7 left-1/2 z-20 hidden -translate-x-1/2 rounded-md bg-slate-900 px-2 py-1 text-xs whitespace-nowrap text-white shadow-lg peer-[:hover]:block"
									>
										{tech}
									</span>
								</div>
							))}
						</div>
					</div>
				</li>
			);
		})
	}
</ul>
