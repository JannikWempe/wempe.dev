---
import { twMerge } from 'tailwind-merge';

interface Props {
	headings: {
		depth: number;
		slug: string;
		text: string;
	}[];
	class?: string;
}

const { headings, class: classes } = Astro.props;
---

<nav class={twMerge('', classes)}>
	<ul class="space-y-2">
		{
			headings.map((heading) => (
				<li
					class:list={[
						'hover:text-blue-600',
						{
							'pl-4': heading.depth === 3,
							'pl-6': heading.depth === 4,
							'pl-8': heading.depth === 5,
							'pl-10': heading.depth === 6,
						},
					]}
				>
					<a
						href={`#${heading.slug}`}
						class="toc-link block text-sm transition-colors duration-200"
						data-heading-id={heading.slug}
					>
						{heading.text}
					</a>
				</li>
			))
		}
	</ul>
</nav>

<script>
	function updateActiveHeading() {
		const headings = document.querySelectorAll('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]');
		const visibleHeadings = new Set<string>();

		headings.forEach((heading) => {
			(heading as HTMLElement).style.scrollMarginTop = '96px';
		});

		function setActiveLink(id: string | null) {
			document.querySelectorAll('.toc-link').forEach((link) => {
				link.classList.remove('text-blue-600');
			});
			if (id) {
				document.querySelector(`[data-heading-id="${id}"]`)?.classList.add('text-blue-600');
			}
		}

		let initialized = false;

		function updateActive() {
			// Pick topmost visible heading (first in DOM order)
			for (const heading of headings) {
				if (visibleHeadings.has(heading.id)) {
					setActiveLink(heading.id);
					initialized = true;
					return;
				}
			}
			// Nothing visible yet on init - set first heading
			if (!initialized && headings.length > 0) {
				setActiveLink(headings[0].id);
				initialized = true;
			}
			// Otherwise keep last active (don't change)
		}

		const observer = new IntersectionObserver(
			(entries) => {
				entries.forEach((entry) => {
					const id = entry.target.id;
					if (entry.isIntersecting) {
						visibleHeadings.add(id);
					} else {
						visibleHeadings.delete(id);
					}
				});
				updateActive();
			},
			{
				rootMargin: '-80px 0px -66% 0px',
				threshold: 0,
			},
		);

		headings.forEach((heading) => observer.observe(heading));

		// Edge case: scrolled to very bottom - activate last heading
		function checkBottom() {
			if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 10) {
				setActiveLink(headings[headings.length - 1]?.id || null);
			}
		}
		window.addEventListener('scroll', checkBottom, { passive: true });

		document.querySelectorAll('.toc-link').forEach((link) => {
			link.addEventListener('click', () => {
				const id = (link as HTMLElement).dataset.headingId;
				if (id) setActiveLink(id);
			});
		});
	}

	document.addEventListener('astro:page-load', updateActiveHeading);
</script>
